<!DOCTYPE html>
<html>
<head>
    <title>ClipCompass</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        video, audio { display: block; margin-bottom: 20px; max-width: 100%; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background: #f2f2f2; }
        td a { color: blue; cursor: pointer; text-decoration: underline; }
        input, select, button { margin-bottom: 20px; padding: 6px; }
    </style>
</head>
<body>
    <h1>ClipCompass</h1>

    <!-- Upload Form -->
    <form id="uploadForm" method="POST" enctype="multipart/form-data" action="{{ url_for('upload_video') }}">
        <label for="videoFile">Select Video:</label>
        <input type="file" name="videoFile" id="videoFile" accept="video/*" required>

        <label for="modelSelect">Select Whisper Model:</label>
        <select name="model" id="modelSelect">
            <option value="tiny">Tiny</option>
            <option value="base">Base</option>
            <option value="small">Small</option>
            <option value="medium">Medium</option>
            <option value="large">Large</option>
        </select>

        <button type="submit">Upload & Process</button>
    </form>

    <!-- Video Preview -->
    <h3>Video Preview:</h3>
    <video id="videoPreview" controls></video>

    {% if video_file %}
    <h2>Processing Results</h2>

    <h3>Original Video:</h3>
    <video id="videoPlayer" controls>
        <source src="{{ url_for('uploaded_file', filename=video_file) }}" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <h3>Extracted Audio:</h3>
    <audio id="audioPlayer" controls>
        <source src="{{ url_for('uploaded_file', filename=audio_file) }}" type="audio/wav">
        Your browser does not support the audio element.
    </audio>

    <h3>Transcript:</h3>
    <p>{{ transcript }}</p>

    <h3>Transcript with Timestamps:</h3>
    <table>
        <thead>
            <tr>
                <th>Start (s)</th>
                <th>End (s)</th>
                <th>Text</th>
            </tr>
        </thead>
        <tbody>
        {% for seg in segments %}
            <tr>
                <td><a href="#" class="seek-link" data-start="{{ seg.start | float }}">{{ seg.start }}</a></td>
                <td>{{ seg.end }}</td>
                <td>{{ seg.text }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <h3>Highlight Clips Order:</h3>
    {% if clips %}
        <form id="clipOrderForm" method="POST" action="{{ url_for('combine_clips') }}">
            <div id="clipList">
                {% for clip in clips %}
                <div class="clip-container" style="margin-bottom: 30px; padding: 10px; border: 1px solid #ccc;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <input type="number" 
                               name="clipOrder_{{ clip }}" 
                               value="{{ loop.index }}" 
                               min="1" 
                               max="{{ clips|length }}"
                               style="width: 60px; margin-right: 10px;">
                        <span>{{ clip }}</span>
                    </div>
                    <video controls width="400">
                        <source src="{{ url_for('serve_clip', filename=clip) }}" type="video/mp4">
                    </video>
                    <a href="{{ url_for('serve_clip', filename=clip) }}" download>Download Clip</a>
                </div>
                {% endfor %}
            </div>
            <button type="submit" style="margin-top: 20px; padding: 10px 20px; background-color: #4CAF50; color: white; border: none; cursor: pointer;">
                Combine Clips in Selected Order
            </button>
        </form>
    {% else %}
        <p>No highlight clips generated.</p>
    {% endif %}

    <h3>Combined Highlight Reel:</h3>
    {% if highlight_reel %}
        <video controls width="600">
            <source src="{{ url_for('serve_clip', filename=highlight_reel) }}" type="video/mp4">
        </video>
        <a href="{{ url_for('serve_clip', filename=highlight_reel) }}" download>Download Highlight Reel</a>
    {% else %}
        <p>No combined highlight reel generated.</p>
    {% endif %}

    {% endif %}

    <script>
        // Preview selected video before upload
        const videoFileInput = document.getElementById('videoFile');
        const videoPreview = document.getElementById('videoPreview');
        videoFileInput.addEventListener('change', () => {
            const file = videoFileInput.files[0];
            if (file) {
                videoPreview.src = URL.createObjectURL(file);
            }
        });

        // Seek to timestamp for processed video/audio
        document.querySelectorAll('.seek-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const seconds = parseFloat(link.dataset.start);
                const video = document.getElementById("videoPlayer");
                const audio = document.getElementById("audioPlayer");
                if (!isNaN(seconds)) {
                    video.currentTime = seconds;
                    audio.currentTime = seconds;
                    video.play();
                    audio.play();
                }
            });
        });
    </script>
</body>
</html>
